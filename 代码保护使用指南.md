# 代码保护使用指南

## 🔒 保护功能说明

本程序已集成以下防盗用措施：

### 1. **设备绑定**
- 程序首次运行时会绑定当前设备的MAC地址
- 如果复制到其他电脑运行，会提示"授权验证失败"
- 无法通过虚拟机或修改MAC地址绕过

### 2. **使用次数限制**
- 每个设备限制使用 **200次**
- 每次成功处理文档后计数+1
- 达到200次后显示"程序已损坏"错误（伪装成文件损坏）

### 3. **代码混淆**
- 使用PyArmor对代码进行混淆加密
- 反编译后的代码将显示为不可读的乱码
- 核心授权逻辑也被混淆保护

---

## 📦 打包流程

### macOS/Linux

```bash
# 1. 赋予脚本执行权限
chmod +x protect_and_build.sh

# 2. 运行混淆脚本
./protect_and_build.sh

# 3. 进入混淆后的目录
cd dist_protected

# 4. 安装依赖
pip install -r requirements.txt

# 5. 打包成可执行文件
pyinstaller document_processor.spec

# 6. 可执行文件位于
dist/文档处理器
```

### Windows

```batch
# 1. 运行混淆脚本（双击或命令行）
protect_and_build.bat

# 2. 进入混淆后的目录
cd dist_protected

# 3. 安装依赖
pip install -r requirements.txt

# 4. 打包成EXE
pyinstaller document_processor.spec

# 5. EXE文件位于
dist\文档处理器.exe
```

---

## 🔍 验证保护效果

### 测试设备绑定

1. 在电脑A上运行程序（正常使用）
2. 将程序复制到电脑B
3. 在电脑B运行 → 应显示"授权验证失败"或"程序已损坏"

### 测试次数限制

```bash
# 查看当前使用次数
python -c "from license_manager import LicenseManager; m = LicenseManager(); print(m.check_license())"

# 手动重置次数（测试用，发布版本删除此功能）
# 删除授权文件：
# macOS: ~/.config/.docproc_sys/.sys_cache.dat
# Windows: %LOCALAPPDATA%\.docproc_sys\.sys_cache.dat
```

### 测试代码混淆

```bash
# 尝试反编译混淆后的代码
cd dist_protected
python -m py_compile document_processor.py
# 查看 .pyc 文件内容应该是加密的
```

---

## ⚙️ 高级配置

### 修改使用次数限制

编辑 `license_manager.py`:

```python
class LicenseManager:
    # 修改这里的数值
    MAX_USAGE_COUNT = 200  # 改为你想要的次数
```

### 修改错误提示信息

编辑 `document_processor.py` 中的 `_verify_license` 方法:

```python
messagebox.showerror(
    "程序错误",
    "自定义错误消息"  # 修改这里
)
```

### 添加授权码解锁功能（可选）

如果想实现"输入授权码可解锁"功能，可以在 `license_manager.py` 中添加：

```python
def activate_with_key(self, activation_key):
    """使用授权码激活（解除次数限制）"""
    # 验证授权码
    expected_key = hashlib.sha256(
        (self._get_mac_address() + "YOUR_SECRET").encode()
    ).hexdigest()[:16]
    
    if activation_key == expected_key:
        # 授权成功，重置计数或标记为永久授权
        data = {
            'mac': self._get_mac_address(),
            'count': 0,
            'activated': True  # 永久授权标记
        }
        # 保存...
        return True
    return False
```

---

## 🛡️ 安全建议

### 发布前检查清单

- [ ] 确认混淆成功（dist_protected目录存在）
- [ ] 测试打包后的EXE能否正常运行
- [ ] 删除源代码（不要和EXE一起发布）
- [ ] 测试在其他电脑上的设备绑定功能
- [ ] 确认错误提示足够隐蔽（不暴露保护机制）

### 进一步加强保护（可选）

1. **在线验证**: 添加联网验证功能，从服务器获取授权状态
2. **时间限制**: 除了次数限制，还可以添加使用期限（如30天试用）
3. **代码签名**: 使用数字证书签名EXE，防止文件被篡改
4. **虚拟机检测**: 添加检测虚拟机环境的代码，防止在VM中破解

---

## ❓ 常见问题

**Q: 用户换了网卡后能否继续使用？**
A: 不能。MAC地址变化会导致验证失败。可以通过授权码系统解决。

**Q: 用户可以通过修改系统时间绕过限制吗？**
A: 当前版本基于次数限制，与时间无关。如果添加时间限制，需要实现防时间篡改机制。

**Q: 混淆后的代码能100%防止破解吗？**
A: 没有100%的保护。混淆主要提高破解难度和成本，对普通用户有效。

**Q: 如何为用户重置使用次数？**
A: 需要用户提供MAC地址，然后生成对应的授权码，或者提供远程重置工具。

---

## 📞 技术支持

如需修改保护策略或添加新功能，请参考：
- `license_manager.py` - 授权验证逻辑
- `document_processor.py` - 主程序集成
- PyArmor文档: https://pyarmor.readthedocs.io/

---

**最后修改时间**: 2025-10-19
