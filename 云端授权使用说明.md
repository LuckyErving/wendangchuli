# 云端授权系统使用说明

## 🎯 快速开始（3分钟配置）

### 第一步：运行配置工具

```bash
python setup_cloud_license.py
```

按照提示操作即可完成配置！

### 第二步：测试

```bash
python cloud_license.py
```

看到 "✅ 测试成功" 就可以了！

## 📋 完整配置步骤

### 1. 获取 GitHub Token

1. 登录 GitHub
2. 访问：https://github.com/settings/tokens
3. 点击 **"Generate new token (classic)"**
4. 填写：
   - Note: `Document Processor License`
   - Expiration: `No expiration` 或选择一个较长的时间
   - 勾选权限：**`gist`** ✅
5. 点击 **"Generate token"**
6. **立即复制** token（以 `ghp_` 开头）

### 2. 配置 Token

**方式A：使用配置工具（推荐）**
```bash
python setup_cloud_license.py
# 按提示粘贴 token
```

**方式B：手动编辑**
```bash
# 编辑 license_config.py
GITHUB_TOKEN = "ghp_你的token"
```

**方式C：环境变量**
```bash
# macOS/Linux
export DOC_PROC_GITHUB_TOKEN="ghp_你的token"

# Windows
set DOC_PROC_GITHUB_TOKEN=ghp_你的token
```

### 3. 安装依赖

```bash
pip install requests
# 或
pip install -r requirements.txt
```

### 4. 测试运行

```bash
python cloud_license.py
```

期望输出：
```
[云授权] 设备ID: abcd1234efgh5678...
[云授权] 缓存文件: /Users/xxx/.docproc_cache/.license_cache
[云授权] 首次使用，初始化数据
[云授权] ✅ 创建 Gist 成功: 1234567890abcdef
[云授权] ✅ 保存到云端成功
[云授权] ✅ 保存到缓存成功
[云授权] ✅ 检查通过，剩余次数: 199

结果: True
消息: 剩余次数: 199
```

## 🔄 集成到主程序

### 方式1：直接替换（推荐）

修改 `document_processor.py`：

```python
# 在文件开头添加
try:
    from license_config import USE_CLOUD
    if USE_CLOUD:
        from cloud_license import CloudLicenseManager as LicenseManager
    else:
        # 保留原来的 LicenseManager 类
        pass
except ImportError:
    # 如果没有配置文件，使用本地版本
    pass
```

### 方式2：配置开关

在 `license_config.py` 中设置：

```python
USE_CLOUD = True   # True=云端，False=本地
```

## 📊 查看使用数据

### 方法1：直接访问 Gist

```
https://gist.github.com/你的用户名/gist_id
```

Gist ID 在首次运行后会保存到 `.gist_config` 文件。

### 方法2：使用 GitHub API

```bash
curl -H "Authorization: token ghp_你的token" \
     https://api.github.com/gists/你的gist_id
```

### 数据格式

```json
{
  "version": "1.0",
  "created_at": "2025-10-19T10:00:00",
  "last_update": "2025-10-19T15:30:00",
  "devices": {
    "设备1的哈希": {
      "device_id": "abc123...",
      "count": 15,
      "first_use": "2025-10-19T10:00:00",
      "last_use": "2025-10-19T15:30:00",
      "platform": "Windows"
    },
    "设备2的哈希": {
      "device_id": "def456...",
      "count": 8,
      "first_use": "2025-10-18T14:00:00",
      "last_use": "2025-10-19T12:00:00",
      "platform": "Darwin"
    }
  }
}
```

## 🛠️ 管理操作

### 重置某个设备的使用次数

1. 访问你的 Gist
2. 点击 "Edit"
3. 找到对应设备，修改 `"count": 0`
4. 点击 "Update secret gist"

### 禁用某个设备

1. 访问你的 Gist
2. 删除对应设备的整个 JSON 对象
3. 或设置 `"count": 200`（达到上限）

### 查看总体使用情况

```python
python -c "
from cloud_license import CloudLicenseManager
manager = CloudLicenseManager()
data = manager._load_from_cloud()
if data:
    devices = data.get('devices', {})
    print(f'总设备数: {len(devices)}')
    for device_id, info in devices.items():
        print(f'{device_id[:8]}... - 使用 {info[\"count\"]} 次 - {info[\"platform\"]}')
"
```

## 🔒 安全建议

### 1. 不要公开 Token

- ❌ 不要提交到公开仓库
- ❌ 不要分享给他人
- ✅ 使用 `.gitignore` 忽略 `license_config.py`
- ✅ 使用环境变量

### 2. Token 权限最小化

只勾选 **`gist`** 权限，不要给其他权限。

### 3. 定期更新 Token

建议每6个月更新一次 Token。

### 4. 监控异常访问

定期检查 Gist 的修改历史，发现异常立即撤销 Token。

## ❓ 常见问题

### Q: Token 泄露了怎么办？

A: 立即访问 https://github.com/settings/tokens 删除该 Token，然后重新生成。

### Q: 网络断开怎么办？

A: 程序会自动使用本地缓存，不影响使用。下次联网时自动同步。

### Q: 多台电脑使用同一个 Token？

A: 可以。每台电脑的设备ID不同，会独立计数。

### Q: 如何迁移到新电脑？

A: 
1. 在新电脑上配置相同的 Token
2. 程序会自动识别为新设备
3. 新设备从0次开始计数

### Q: GitHub API 有访问限制吗？

A: 有，但足够用：
- 已认证：5000次/小时
- 未认证：60次/小时
- 每次使用程序只需2-3次API调用

### Q: 数据会丢失吗？

A: 不会：
- 云端存储在 GitHub（高可用）
- 本地有缓存备份
- Gist 有版本历史

## 📦 打包注意事项

### PyInstaller 配置

```bash
pyinstaller --clean --onefile \
    --add-data "license_config.py:." \
    --hidden-import=requests \
    --hidden-import=urllib3 \
    document_processor.py
```

### GitHub Actions 构建

在 `.github/workflows/build_windows.yml` 中添加：

```yaml
- name: Create license config
  run: |
    echo 'GITHUB_TOKEN = "${{ secrets.GITHUB_TOKEN }}"' > license_config.py
    echo 'MAX_USAGE_COUNT = 200' >> license_config.py
    echo 'TIMEOUT = 5' >> license_config.py
    echo 'USE_CLOUD = True' >> license_config.py
```

## 🎉 完成！

配置完成后，你就可以：

✅ 实时监控所有设备的使用情况
✅ 远程控制设备授权
✅ 防止本地文件篡改
✅ 跨设备数据同步
✅ 离线时自动降级

开始使用吧！
