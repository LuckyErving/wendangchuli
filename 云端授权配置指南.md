# 云端授权系统配置指南

## 方案概述

**云端优先 + 本地缓存**的混合授权方案：

```
用户使用程序
    ↓
尝试连接云端服务器
    ↓
成功？ → 从云端读取/更新使用次数 → 同步到本地缓存
    ↓
失败？ → 使用本地缓存 → 下次联网时同步
```

## 优势

✅ **防篡改**：数据存储在云端，用户无法直接修改
✅ **跨设备同步**：同一设备在不同环境下数据一致
✅ **离线可用**：网络断开时使用缓存，不影响使用
✅ **实时监控**：可以随时查看所有设备的使用情况
✅ **远程控制**：可以远程重置/禁用某个设备

## 免费云服务选择

### 方案1：GitHub Gist（推荐）⭐

**优点：**
- 完全免费
- 稳定可靠
- API 简单
- 无需服务器

**限制：**
- 需要 GitHub 账号
- API 速率限制：5000次/小时（足够用）

**配置步骤：**

1. **创建 GitHub Personal Access Token**
   - 访问：https://github.com/settings/tokens
   - 点击 "Generate new token (classic)"
   - 勾选权限：`gist` (创建和管理 gists)
   - 复制生成的 token（ghp_开头）

2. **配置到代码**
   ```python
   GITHUB_TOKEN = "ghp_你的token"  # 替换这里
   ```

3. **首次运行自动创建 Gist**
   - 程序会自动创建私有 Gist
   - Gist ID 会保存到 `.gist_config` 文件

### 方案2：Firebase Realtime Database（备选）

**优点：**
- 完全免费（有额度）
- 实时同步
- 支持复杂查询

**限制：**
- 需要 Google 账号
- 配置稍复杂

### 方案3：LeanCloud（国内备选）

**优点：**
- 国内访问快
- 免费额度充足
- 中文文档

**限制：**
- 需要实名认证

## 完整实现方案

### 1. 使用 GitHub Gist（最简单）

```python
# cloud_license.py 已实现
# 只需要配置 GITHUB_TOKEN
```

### 2. 数据结构

```json
{
  "version": "1.0",
  "created_at": "2025-10-19T10:00:00",
  "last_update": "2025-10-19T10:05:00",
  "devices": {
    "设备ID哈希1": {
      "device_id": "abcd1234...",
      "count": 5,
      "first_use": "2025-10-19T10:00:00",
      "last_use": "2025-10-19T10:05:00",
      "platform": "Windows"
    },
    "设备ID哈希2": {
      "device_id": "efgh5678...",
      "count": 3,
      "first_use": "2025-10-18T15:00:00",
      "last_use": "2025-10-19T09:00:00",
      "platform": "Darwin"
    }
  }
}
```

### 3. 集成到主程序

在 `document_processor.py` 中：

```python
# 选择使用云端授权还是本地授权
USE_CLOUD_LICENSE = True  # True=云端，False=本地

if USE_CLOUD_LICENSE:
    from cloud_license import CloudLicenseManager
    license_manager = CloudLicenseManager()
else:
    license_manager = LicenseManager()  # 原来的本地版本
```

## 安全性增强

### 1. Token 加密存储

不要直接在代码中写 Token，而是：

```python
# 方式1：环境变量
GITHUB_TOKEN = os.environ.get('DOC_PROC_GITHUB_TOKEN', '')

# 方式2：加密配置文件
def _load_encrypted_token(self):
    # 从加密文件读取
    pass
```

### 2. 请求签名验证

```python
def _sign_request(self, data: dict) -> str:
    """生成请求签名"""
    secret = "your_secret_key"
    signature = hashlib.sha256(f"{json.dumps(data)}{secret}".encode()).hexdigest()
    return signature
```

### 3. 数据加密

```python
def _encrypt_data(self, data: dict) -> str:
    """加密云端数据"""
    from cryptography.fernet import Fernet
    key = Fernet.generate_key()
    f = Fernet(key)
    return f.encrypt(json.dumps(data).encode()).decode()
```

## 使用流程

### 开发者端

1. **配置 GitHub Token**
   ```bash
   # 设置环境变量（推荐）
   export DOC_PROC_GITHUB_TOKEN="ghp_your_token"
   
   # 或修改代码
   GITHUB_TOKEN = "ghp_your_token"
   ```

2. **首次运行测试**
   ```bash
   python cloud_license.py
   ```

3. **集成到主程序**
   ```python
   # 在 SimpleGUI.__init__ 中
   self.license_manager = CloudLicenseManager()
   ```

4. **打包时包含 requests 库**
   ```bash
   pip install requests
   # 添加到 requirements.txt
   ```

### 用户端

1. 下载并运行 exe
2. 程序自动连接云端
3. 无需任何配置
4. 离线时自动使用缓存

## 监控和管理

### 查看所有设备使用情况

访问你的 Gist：
```
https://gist.github.com/你的用户名/gist_id
```

### 重置某个设备

编辑 Gist，修改对应设备的 count 值

### 禁用某个设备

删除 Gist 中对应设备的记录，或设置 count 为 200

## 故障处理

### 网络超时
- 自动降级到本地缓存
- 不影响程序使用
- 下次联网时自动同步

### Token 失效
- 重新生成 token
- 更新配置文件

### Gist 被删除
- 程序会自动创建新的 Gist
- 所有设备重新计数

## 成本分析

| 服务 | 免费额度 | 够用吗？ |
|------|---------|---------|
| GitHub Gist | 5000请求/小时 | ✅ 足够100个用户 |
| Firebase | 10万次/天 | ✅ 足够1000个用户 |
| LeanCloud | 3万次/天 | ✅ 足够500个用户 |

## 推荐配置

**小规模（<50设备）**
- 使用 GitHub Gist
- 无需额外成本
- 配置最简单

**中等规模（50-500设备）**
- 使用 Firebase 或 LeanCloud
- 更好的性能和监控
- 需要简单配置

**大规模（>500设备）**
- 自建服务器
- 完全可控
- 需要开发成本

## 下一步

1. ✅ 已创建 `cloud_license.py`
2. ⏳ 配置你的 GitHub Token
3. ⏳ 测试云端授权功能
4. ⏳ 集成到 `document_processor.py`
5. ⏳ 更新 `requirements.txt` 添加 requests
6. ⏳ 重新打包测试

需要我帮你完成集成吗？
