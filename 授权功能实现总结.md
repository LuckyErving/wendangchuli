# 设备授权功能实现总结

## ✅ 已完成的功能

### 1. 核心授权系统 (LicenseManager)

**位置**: `document_processor.py` 第23-162行

**功能**:
- ✅ 获取设备MAC地址
- ✅ 生成设备唯一指纹（SHA256）
- ✅ 加密存储使用记录（Base64混淆）
- ✅ 验证设备绑定
- ✅ 限制使用次数（200次）
- ✅ 记录首次和最后使用时间

### 2. GUI集成

**位置**: `document_processor.py` SimpleGUI类

**功能**:
- ✅ 启动时自动检查授权
- ✅ 超限时显示"程序已损坏"错误并退出
- ✅ 界面显示使用次数信息
- ✅ 剩余≤20次时弹窗警告
- ✅ 首次使用自动绑定设备

### 3. 测试工具

**文件**: `test_license.py`

**功能**:
- ✅ 查看授权状态
- ✅ 模拟使用N次
- ✅ 重置授权（开发用）
- ✅ 显示详细使用信息

### 4. 配置文件管理

**路径**:
- Windows: `%APPDATA%\.docproc\.lic`
- macOS/Linux: `~/.docproc/.lic`

**特性**:
- ✅ 自动创建配置目录
- ✅ 加密保存使用数据
- ✅ Windows下设为隐藏文件
- ✅ 配置与设备绑定，无法迁移

## 📋 技术实现细节

### 设备识别
```python
# 获取MAC地址
mac = uuid.getnode()
# 生成设备指纹
device_hash = hashlib.sha256(f"{mac}{salt}").hexdigest()
```

### 数据加密
```python
# 3次Base64编码混淆
encrypted = base64.b64encode(base64.b64encode(base64.b64encode(json_bytes)))
```

### 使用次数检查
```python
if current_count >= MAX_USAGE_COUNT:  # 200次
    return False, "程序使用次数已达上限"
```

### 错误提示
```python
messagebox.showerror(
    "程序已损坏", 
    "抱歉，程序文件已损坏，无法继续使用。"
)
```

## 🧪 测试结果

### 测试1: 首次使用
```bash
$ python3 test_license.py
剩余使用次数: 200
授权检查结果: ✅ 是
消息: 首次使用，剩余次数: 199
```

### 测试2: 正常使用
```bash
$ python3 test_license.py --simulate 5
第 1 次: 剩余使用次数: 199
第 2 次: 剩余使用次数: 198
...
最终状态: 已使用: 5 次，剩余: 195 次
```

### 测试3: 达到上限
```bash
$ python3 test_license.py --simulate 200
...
第 200 次: 剩余使用次数: 0
第 201 次: 程序使用次数已达上限
❌ 在第 201 次时被阻止
```

## 📦 打包注意事项

### 打包前必须执行

```bash
# macOS/Linux
./clean_before_build.sh

# Windows
clean_before_build.bat
```

**目的**:
1. 删除开发时产生的授权记录
2. 清理Python缓存文件
3. 清理旧的构建文件
4. 确保用户首次运行时才开始计数

### 打包后测试

1. 首次运行 → 应显示"剩余199次"
2. 多次运行 → 次数正常递减
3. 重启程序 → 次数累计正确
4. 达到200次 → 显示"程序已损坏"错误

## 🛡️ 安全特性

1. **设备绑定**: MAC地址哈希，无法迁移到其他设备
2. **加密存储**: 配置文件加密，不可直接编辑
3. **隐藏配置**: 普通用户不易发现配置文件
4. **完整性校验**: 每次启动验证设备和计数
5. **错误迷惑**: 达到上限时显示"程序已损坏"而非"次数用完"

## 📝 用户场景

### 场景1: 正常使用
1. 用户首次运行程序
2. 自动绑定到当前设备
3. 界面显示"剩余199次"
4. 每次使用后次数递减

### 场景2: 接近上限
1. 剩余次数≤20
2. 启动时弹窗警告
3. 提示即将达到使用上限

### 场景3: 达到上限
1. 已使用200次
2. 启动时显示"程序已损坏"错误
3. 程序自动退出
4. 无法继续使用

### 场景4: 尝试迁移
1. 用户复制程序到其他电脑
2. 启动时检测到设备不匹配
3. 显示"程序已损坏"错误
4. 无法在新设备使用

## 📚 相关文档

- `设备授权说明.md` - 详细技术文档
- `授权系统更新记录.md` - 功能更新记录
- `test_license.py` - 测试工具源码

## 🔧 开发者命令

```bash
# 查看当前授权状态
python3 test_license.py

# 模拟使用10次
python3 test_license.py --simulate 10

# 重置授权（仅开发测试用）
python3 test_license.py --reset

# 打包前清理
./clean_before_build.sh  # macOS
clean_before_build.bat   # Windows

# 打包程序
./build_exe_mac.sh       # macOS
build_exe.bat            # Windows
```

## ⚠️ 重要提醒

1. **打包前务必运行清理脚本**，否则用户首次使用时计数不从0开始
2. **不要将测试产生的配置文件打包进exe**
3. **配置文件在用户目录，不在程序目录**
4. **测试工具不要发布给最终用户**
5. **重置功能仅供开发测试使用**

## 🎯 下一步建议

1. 在实际设备上完整测试打包后的exe
2. 验证跨平台兼容性
3. 测试重装系统后的表现
4. 考虑添加远程授权管理（可选）
5. 实现授权延期功能（可选）
