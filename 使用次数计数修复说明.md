# 使用次数计数修复说明

## 问题描述

之前的版本中，使用次数不会递减。原因是：
- 授权检查只在程序**启动时**执行一次
- 每次**处理文档时**不会检查和更新计数
- 用户可以启动一次程序，处理无限次文档

## 修复方案

### 1. 拆分授权检查逻辑

将原来的 `check_and_update_usage()` 拆分为两个方法：

**check_device()** - 仅检查设备绑定（程序启动时使用）
```python
def check_device(self) -> Tuple[bool, str]:
    """
    仅检查设备绑定，不更新计数（用于程序启动时）
    """
    # 验证设备，不增加计数
    # 首次使用时初始化为 count=0
```

**check_and_update_usage()** - 检查并更新使用次数（每次处理文档时使用）
```python
def check_and_update_usage(self) -> Tuple[bool, str]:
    """
    检查并更新使用次数（每次处理文档时调用）
    """
    # 检查设备绑定
    # 检查是否达到上限
    # 更新使用次数 +1
```

### 2. 修改GUI初始化

程序启动时只检查设备绑定，不计数：

```python
def __init__(self):
    # 使用 check_device() 而不是 check_and_update_usage()
    can_use, message = self.license_manager.check_device()
    
    if not can_use:
        # 显示错误并退出
        ...
```

### 3. 在处理文档时检查并计数

每次点击"开始处理"按钮时，检查并更新使用次数：

```python
def process(self):
    # 检查并更新使用次数
    can_use, usage_message = self.license_manager.check_and_update_usage()
    
    if not can_use:
        # 达到上限，拒绝处理
        messagebox.showerror("程序已损坏", ...)
        return
    
    # 更新界面显示
    self.update_license_display()
    
    # 继续处理文档...
```

### 4. 实时更新界面显示

添加 `update_license_display()` 方法，在每次处理后更新界面上的使用次数：

```python
def update_license_display(self):
    """更新界面上的授权信息显示"""
    usage_info = self.license_manager.get_usage_info()
    # 更新标签显示
    ...
```

## 测试结果

使用 `test_usage_flow.py` 测试完整流程：

```
【步骤1】程序启动 - 检查设备绑定
  当前状态: 已使用: 1 次，剩余: 199 次  ✅ 初始化，count=0

【步骤2】第一次处理文档 - 检查并更新计数
  当前状态: 已使用: 2 次，剩余: 198 次  ✅ count +1

【步骤3】第二次处理文档 - 检查并更新计数
  当前状态: 已使用: 3 次，剩余: 197 次  ✅ count +1

【步骤4】第三次处理文档 - 检查并更新计数
  当前状态: 已使用: 4 次，剩余: 196 次  ✅ count +1

【步骤5】程序重启 - 再次检查设备绑定（不增加计数）
  当前状态: 已使用: 4 次，剩余: 196 次  ✅ count 不变

【步骤6】重启后第一次处理文档
  当前状态: 已使用: 5 次，剩余: 195 次  ✅ count +1
```

## 使用逻辑总结

### 正确的计数方式

- **程序启动**: 0次计数（只验证设备）
- **处理文档**: 每次 +1 计数
- **选择文件夹**: 0次计数（只是准备）
- **取消处理**: 0次计数（未实际执行）

### 达到上限的行为

当 `count >= 200` 时：
1. 程序可以启动（只验证设备）
2. 但无法处理文档（check_and_update_usage 返回 False）
3. 显示"程序已损坏"错误

### 用户体验

```
启动程序 → 界面显示: 已使用: 0 次，剩余: 200 次
  ↓
选择文件夹 → (不计数)
  ↓
点击处理 → 检查并计数 → 已使用: 1 次，剩余: 199 次
  ↓
继续处理 → 检查并计数 → 已使用: 2 次，剩余: 198 次
  ↓
...
  ↓
第200次处理 → 成功 → 已使用: 200 次，剩余: 0 次
  ↓
第201次处理 → ❌ 拒绝 → "程序已损坏"
```

## 关键改进

### 修复前
- ❌ 启动时计数 +1
- ❌ 处理文档不计数
- ❌ 一次启动可以无限处理

### 修复后
- ✅ 启动时只验证设备
- ✅ 每次处理文档计数 +1
- ✅ 严格限制处理次数为200次
- ✅ 实时更新界面显示
- ✅ 达到上限时及时提醒

## 测试工具

```bash
# 测试完整流程
python3 test_usage_flow.py

# 查看当前状态
python3 test_license.py

# 模拟使用N次
python3 test_license.py --simulate 10

# 重置授权
python3 test_license.py --reset
```

## 提交说明

修复内容：
- 拆分授权检查为 `check_device()` 和 `check_and_update_usage()`
- 程序启动时只验证设备，不计数
- 每次处理文档时检查并更新计数
- 添加实时更新界面显示
- 修复使用信息显示文本

---

**修复完成！现在使用次数会正确递减，每处理一次文档计数 +1。** ✅
