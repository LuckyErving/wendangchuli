# 设备授权与使用限制说明

## 功能概述

文档处理器现在实现了基于MAC地址的设备绑定和使用次数限制功能：

- **设备绑定**: 程序首次运行时自动绑定到当前设备的MAC地址
- **使用限制**: 每台设备最多可使用 **200次**
- **安全保护**: 使用加密存储，防止简单修改

## 工作原理

### 1. 设备识别
- 程序启动时自动获取设备的MAC地址
- 生成唯一的设备指纹（SHA256哈希）
- 首次运行时绑定到当前设备

### 2. 使用计数
- 每次启动程序并处理文档时，使用次数 +1
- 使用记录加密保存在隐藏配置文件中
  - **Windows**: `%APPDATA%\.docproc\.lic`
  - **macOS/Linux**: `~/.docproc/.lic`

### 3. 限制检查
- 达到200次后，程序显示"程序已损坏"错误
- 无法在其他设备上使用（已绑定设备）

## 用户界面提示

### 正常使用
- 界面右上角显示：`📋 已使用: X 次，剩余: Y 次`
- 剩余次数充足时不会弹窗

### 警告提醒
- 剩余次数 ≤ 20 时，启动时弹窗提醒
- 提示用户即将达到使用上限

### 达到上限
- 显示错误："程序文件已损坏，无法继续使用"
- 程序自动退出

## 测试工具

使用 `test_license.py` 进行测试：

```bash
# 查看当前授权状态
python3 test_license.py

# 模拟使用N次
python3 test_license.py --simulate 10

# 重置授权（删除配置文件）
python3 test_license.py --reset
```

## 技术实现

### 加密方式
- 使用Base64多次编码混淆数据
- SHA256生成设备指纹
- 配置文件设置为隐藏属性（Windows）

### 存储数据结构
```json
{
  "device": "设备指纹哈希",
  "count": 使用次数,
  "first_use": "首次使用时间",
  "last_use": "最近使用时间"
}
```

### 安全特性
1. **设备绑定**: 配置文件与设备MAC地址绑定，无法迁移
2. **加密存储**: 数据经过加密，不能直接修改
3. **隐藏文件**: 配置文件对普通用户不可见
4. **完整性检查**: 每次启动验证设备和次数

## 注意事项

### 开发测试
- 开发时可使用 `--reset` 清除授权记录
- 打包前确保删除测试产生的配置文件

### 用户迁移
- 程序绑定到首次运行的设备
- 无法在其他电脑上使用
- 重装系统可能导致MAC地址变化（取决于网卡）

### 次数重置
- 无内置重置功能（普通用户无法重置）
- 需要技术支持手动处理

## 打包注意事项

使用PyInstaller打包时，确保：

```bash
# 打包命令
pyinstaller --onefile --windowed document_processor.py

# 打包后测试
./dist/document_processor
```

配置文件会在用户第一次运行时自动创建在用户目录下，不会打包进exe中。

## 常见问题

**Q: 如何查看剩余次数？**  
A: 启动程序后，界面右上角会显示使用情况。

**Q: 达到200次后怎么办？**  
A: 程序会显示"已损坏"错误，需要联系技术支持获取新版本。

**Q: 更换电脑可以用吗？**  
A: 不可以，程序已绑定到首次运行的设备。

**Q: 重装系统后还能用吗？**  
A: 取决于网卡MAC地址是否改变，通常物理网卡MAC不变，可以继续使用。

**Q: 如何重置授权（仅开发者）？**  
A: 运行 `python3 test_license.py --reset` 或手动删除配置目录。
