# 使用次数计数功能 - 最终说明

## ✅ 问题已解决

使用次数现在会正确递减，关闭exe后重新打开次数保持累计，不会重置。

## 工作原理

### 1. 程序启动时
- 调用 `check_device()` - 仅验证设备绑定
- **不增加**使用次数
- 初始化配置文件（首次使用时 count=0）

### 2. 每次处理文档时
- 调用 `check_and_update_usage()` - 检查并更新计数
- 使用次数 **+1**
- 更新配置文件
- 实时更新界面显示

### 3. 关闭并重新打开
- 配置文件保存在 `~/.docproc/.lic` (macOS) 或 `%APPDATA%\.docproc\.lic` (Windows)
- 次数信息持久化保存
- 重新打开时从文件加载，**次数累计保持**

## 测试验证

### 场景1：连续处理文档
```
启动程序 → 已使用: 0 次，剩余: 200 次
处理文档1 → 已使用: 1 次，剩余: 199 次 ✅
处理文档2 → 已使用: 2 次，剩余: 198 次 ✅
处理文档3 → 已使用: 3 次，剩余: 197 次 ✅
```

### 场景2：关闭重启
```
第一次运行:
  启动    → 已使用: 0 次，剩余: 200 次
  处理1   → 已使用: 1 次，剩余: 199 次
  处理2   → 已使用: 2 次，剩余: 198 次
  处理3   → 已使用: 3 次，剩余: 197 次
  [关闭程序]

第二次运行:
  启动    → 已使用: 3 次，剩余: 197 次 ✅ 次数保持
  处理4   → 已使用: 4 次，剩余: 196 次 ✅
  处理5   → 已使用: 5 次，剩余: 195 次 ✅
```

### 场景3：达到上限
```
第200次处理 → 已使用: 200 次，剩余: 0 次 ✅ 成功
第201次处理 → ❌ 程序已损坏，无法继续使用 ✅ 正确阻止
```

## 界面显示

- 右上角实时显示：`📋 已使用: X 次，剩余: Y 次`
- 每次处理完成后自动更新
- 剩余≤20次时弹窗警告

## 配置文件

**位置**:
- macOS: `~/.docproc/.lic`
- Windows: `%APPDATA%\.docproc\.lic`

**内容** (加密后):
```json
{
  "device": "设备指纹哈希",
  "count": 5,
  "first_use": "2025-10-19T21:18:37.099709",
  "last_use": "2025-10-19T21:18:37.100783"
}
```

## 测试命令

```bash
# 简单计数测试
python3 test_simple.py

# 关闭重启测试
python3 test_restart.py

# 查看当前状态
python3 test_license.py

# 模拟使用N次
python3 test_license.py --simulate 10

# 重置授权（开发用）
python3 test_license.py --reset
# 或直接删除配置
rm -rf ~/.docproc  # macOS
rmdir /s /q %APPDATA%\.docproc  # Windows
```

## 关键改进点

### ✅ 修复前的问题
- 启动时计数 +1（不正确）
- 处理文档不计数（不正确）
- 一次启动可无限处理

### ✅ 修复后的行为
- 启动时只验证设备
- 每次处理文档计数 +1
- 界面实时更新显示
- 关闭重启后次数累计保持
- 严格限制200次使用

## 用户体验流程

```
[第1天]
启动程序 → 界面显示: 已使用: 0 次，剩余: 200 次
处理5个文档 → 界面显示: 已使用: 5 次，剩余: 195 次
关闭程序

[第2天]
启动程序 → 界面显示: 已使用: 5 次，剩余: 195 次 ✅ 累计保持
处理10个文档 → 界面显示: 已使用: 15 次，剩余: 185 次
关闭程序

...继续使用...

[某天]
启动程序 → 界面显示: 已使用: 195 次，剩余: 5 次
处理5个文档 → 界面显示: 已使用: 200 次，剩余: 0 次
尝试再处理 → ❌ 显示"程序已损坏"错误
```

## 安全特性

1. **设备绑定**: 首次运行时绑定MAC地址
2. **加密存储**: 配置文件使用Base64多重编码
3. **隐藏文件**: Windows下设置为隐藏属性
4. **持久化**: 关闭程序后数据保持
5. **防篡改**: 修改配置文件会导致验证失败

## 代码结构

```python
class LicenseManager:
    def check_device(self):
        """程序启动时调用 - 只验证设备"""
        # 验证设备绑定
        # 不增加计数
        
    def check_and_update_usage(self):
        """处理文档时调用 - 检查并计数"""
        # 验证设备绑定
        # 检查使用次数
        # 计数 +1
        # 保存到文件
    
    def get_usage_info(self):
        """获取使用信息用于显示"""
        # 返回: "已使用: X 次，剩余: Y 次"

class SimpleGUI:
    def __init__(self):
        # 启动时只验证设备
        self.license_manager.check_device()
        
    def process(self):
        # 处理文档时检查并计数
        can_use, msg = self.license_manager.check_and_update_usage()
        if not can_use:
            # 显示错误
            return
        # 更新界面显示
        self.update_license_display()
        # 继续处理...
```

## 提交记录

```
commit 51ef6ca
修复使用次数计数：每次处理文档正确递减，关闭重启后次数累计保持

- 拆分授权检查：check_device()仅验证设备，check_and_update_usage()更新计数
- 程序启动时只验证设备，不增加计数
- 每次处理文档时检查并更新计数+1
- 改进界面更新：直接保存标签引用，处理完成后立即更新显示
- 添加测试脚本：test_simple.py和test_restart.py验证计数逻辑
- 确保关闭重启后次数累计正确，不会重置
```

---

## ✅ 功能完全正常

现在使用次数功能完全按预期工作：
- ✅ 每次处理文档递减1次
- ✅ 关闭重启后次数累计保持
- ✅ 达到200次后无法继续使用
- ✅ 界面实时显示使用情况
- ✅ 设备绑定防止迁移

**可以放心打包发布！** 🎉
